<div class="perfil-container">
  <div class="perfil-header">
    <button class="btn-back" (click)="goBack()">
      <i class="fas fa-arrow-left"></i>
      Volver al Dashboard
    </button>
    <h1>Mi Perfil de Productor</h1>
  </div>

  @if(!loading) {
  <div class="perfil-content">
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="perfil-form">
      <!-- Imagen del Productor -->
      <div class="form-section">
        <h2>Imagen de la Empresa</h2>
        <app-image-upload-panel
          [currentImageUrl]="form.value.imagenUrl || undefined"
          uploadType="perfil"
          (imageUploaded)="onImageUploaded($event)"
          (imageRemoved)="onImageRemoved()"
        >
        </app-image-upload-panel>
      </div>

      <!-- Información Básica -->
      <div class="form-section">
        <h2>Información de la Empresa</h2>

        <div class="form-row">
          <div class="form-group">
            <label for="nombre">Nombre de la Empresa *</label>
            <input
              type="text"
              id="nombre"
              formControlName="nombre"
              class="form-control"
              placeholder="Ej: Huerta Los Olivos"
            />
            @if(form.get('nombre')?.touched && form.get('nombre')?.errors) {
            <div class="field-error">
              @if(form.get('nombre')?.errors?.['required']) {
              <span>El nombre es obligatorio</span>
              } @if(form.get('nombre')?.errors?.['minlength']) {
              <span>El nombre debe tener al menos 2 caracteres</span>
              }
            </div>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="direccion">Dirección *</label>
            <textarea
              id="direccion"
              formControlName="direccion"
              class="form-control"
              rows="3"
              placeholder="Dirección completa de la empresa o finca"
            ></textarea>
            @if(form.get('direccion')?.touched && form.get('direccion')?.errors) {
            <div class="field-error">
              @if(form.get('direccion')?.errors?.['required']) {
              <span>La dirección es obligatoria</span>
              }
            </div>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="telefono">Teléfono de Contacto *</label>
            <input
              type="tel"
              id="telefono"
              formControlName="telefono"
              class="form-control"
              placeholder="123456789"
            />
            @if(form.get('telefono')?.touched && form.get('telefono')?.errors) {
            <div class="field-error">
              @if(form.get('telefono')?.errors?.['required']) {
              <span>El teléfono es obligatorio</span>
              } @if(form.get('telefono')?.errors?.['pattern']) {
              <span>Introduce un teléfono válido (9 dígitos)</span>
              }
            </div>
            }
          </div>
        </div>
      </div>

      <!-- Información de la Cuenta -->
      @if(productor) {
      <div class="form-section">
        <h2>Información de la Cuenta</h2>

        <div class="info-grid">
          <div class="info-item">
            <label>Email de la cuenta</label>
            <p>{{ currentUser?.email }}</p>
          </div>

          <div class="info-item">
            <label>Fecha de registro</label>
            <p>{{ productor.fechaRegistro | date : 'dd/MM/yyyy' }}</p>
          </div>

          <div class="info-item">
            <label>Tipo de usuario</label>
            <span class="badge badge--green">{{ currentUser?.tipoUsuario }}</span>
          </div>

          <div class="info-item">
            <label>ID del productor</label>
            <p>#{{ productor.idProductor }}</p>
          </div>
        </div>
      </div>
      }

      <!-- Acciones -->
      <div class="form-actions">
        <button type="button" class="btn btn--outline" (click)="goBack()">Cancelar</button>

        <button type="submit" class="btn btn--primary" [disabled]="form.invalid || saving">
          @if(!saving) {
          <i class="fas fa-save"></i>
          } @if(saving) {
          <div class="button-spinner"></div>
          }
          {{ saving ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
      </div>
    </form>
  </div>
  } @else {
  <div class="loading-container">
    <div class="spinner"></div>
    <p>Cargando perfil...</p>
  </div>
  }
</div>
