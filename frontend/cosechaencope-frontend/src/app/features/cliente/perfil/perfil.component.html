<div class="perfil-container">
  <div class="perfil-header">
    <button class="btn-back" (click)="goBack()">
      <i class="fas fa-arrow-left"></i>
      Volver al Panel
    </button>
    <h1>
      <i class="fas fa-user-edit"></i>
      Mi Perfil
    </h1>
  </div>

  <div class="perfil-content" *ngIf="!loading; else loadingTemplate">
    <!-- Información de cuenta -->
    <div class="info-card">
      <div class="info-card__header">
        <i class="fas fa-info-circle"></i>
        <h2>Información de Cuenta</h2>
      </div>
      <div class="info-card__body">
        <div class="info-item">
          <label>Email:</label>
          <span>{{ currentUser?.email }}</span>
        </div>
        <div class="info-item">
          <label>Tipo de cuenta:</label>
          <span class="badge badge--primary">Cliente</span>
        </div>
        <div class="info-item" *ngIf="cliente">
          <label>Miembro desde:</label>
          <span>{{ cliente.fechaRegistro | date:'dd/MM/yyyy' }}</span>
        </div>
      </div>
    </div>

    <!-- Formulario de datos personales -->
    <div class="form-card">
      <div class="form-card__header">
        <i class="fas fa-edit"></i>
        <h2>Datos Personales</h2>
      </div>
      
      <!-- Mensajes de feedback -->
      <div class="alert alert--success" *ngIf="successMessage">
        {{ successMessage }}
      </div>
      <div class="alert alert--error" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>

      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="form-card__body">
        <!-- Nombre -->
        <div class="form-group">
          <label for="nombre">
            <i class="fas fa-user"></i>
            Nombre Completo *
          </label>
          <input 
            type="text" 
            id="nombre" 
            formControlName="nombre"
            placeholder="Ej: Juan García López"
            [class.is-invalid]="nombreControl?.invalid && nombreControl?.touched">
          <div class="form-error" *ngIf="nombreControl?.invalid && nombreControl?.touched">
            <span *ngIf="nombreControl?.errors?.['required']">El nombre es obligatorio</span>
            <span *ngIf="nombreControl?.errors?.['minlength']">El nombre debe tener al menos 3 caracteres</span>
          </div>
        </div>

        <!-- Dirección Desglosada -->
        <div class="form-group">
          <label>
            <i class="fas fa-map-marker-alt"></i>
            Dirección de Envío
          </label>
          
          <!-- Calle -->
          <div class="mb-3">
            <label for="calle" class="sub-label">Calle y número *</label>
            <input 
              type="text" 
              id="calle" 
              formControlName="calle"
              placeholder="Ej: Calle Mayor 123, 4º B"
              [class.is-invalid]="form.get('calle')?.invalid && form.get('calle')?.touched">
            <div class="form-error" *ngIf="form.get('calle')?.invalid && form.get('calle')?.touched">
              <span>La calle es obligatoria</span>
            </div>
          </div>

          <div class="row-grid">
            <!-- CP -->
            <div>
              <label for="cp" class="sub-label">Código Postal *</label>
              <input 
                type="text" 
                id="cp" 
                formControlName="cp"
                placeholder="28001"
                maxlength="5"
                [class.is-invalid]="form.get('cp')?.invalid && form.get('cp')?.touched">
              <div class="form-error" *ngIf="form.get('cp')?.invalid && form.get('cp')?.touched">
                <span>CP inválido (5 dígitos)</span>
              </div>
            </div>

            <!-- Localidad -->
            <div>
              <label for="localidad" class="sub-label">Localidad *</label>
              <input 
                type="text" 
                id="localidad" 
                formControlName="localidad"
                placeholder="Madrid"
                [class.is-invalid]="form.get('localidad')?.invalid && form.get('localidad')?.touched">
              <div class="form-error" *ngIf="form.get('localidad')?.invalid && form.get('localidad')?.touched">
                <span>Localidad obligatoria</span>
              </div>
            </div>
          </div>

          <!-- Provincia -->
          <div class="mt-3">
            <label for="provincia" class="sub-label">Provincia *</label>
            <select 
              id="provincia" 
              formControlName="provincia"
              [class.is-invalid]="form.get('provincia')?.invalid && form.get('provincia')?.touched">
              <option value="" disabled selected>Selecciona una provincia</option>
              <option *ngFor="let prov of provincias" [value]="prov">{{ prov }}</option>
            </select>
            <div class="form-error" *ngIf="form.get('provincia')?.invalid && form.get('provincia')?.touched">
              <span>Selecciona una provincia</span>
            </div>
          </div>
        </div>

        <!-- Teléfono -->
        <div class="form-group">
          <label for="telefono">
            <i class="fas fa-phone"></i>
            Teléfono de Contacto *
          </label>
          <input 
            type="tel" 
            id="telefono" 
            formControlName="telefono"
            placeholder="Ej: 612345678"
            maxlength="9"
            [class.is-invalid]="telefonoControl?.invalid && telefonoControl?.touched">
          <div class="form-error" *ngIf="telefonoControl?.invalid && telefonoControl?.touched">
            <span *ngIf="telefonoControl?.errors?.['required']">El teléfono es obligatorio</span>
            <span *ngIf="telefonoControl?.errors?.['pattern']">El teléfono debe tener 9 dígitos</span>
          </div>
          <small class="form-hint">
            <i class="fas fa-info-circle"></i>
            Solo números, sin espacios (9 dígitos)
          </small>
        </div>

        <!-- Botones -->
        <div class="form-actions">
          <button 
            type="button" 
            class="btn btn--outline" 
            (click)="goBack()"
            [disabled]="saving">
            <i class="fas fa-times"></i>
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn btn--primary" 
            [disabled]="form.invalid || saving">
            <i class="fas fa-spinner fa-spin" *ngIf="saving"></i>
            <i class="fas fa-save" *ngIf="!saving"></i>
            {{ saving ? 'Guardando...' : 'Guardar Cambios' }}
          </button>
        </div>
      </form>
    </div>

    <!-- Información adicional -->
    <div class="help-card">
      <i class="fas fa-lightbulb"></i>
      <h3>Consejos</h3>
      <ul>
        <li>Mantén tu dirección actualizada para recibir tus pedidos sin problemas</li>
        <li>El teléfono es importante para que el productor pueda contactarte</li>
        <li>Tu email no se puede cambiar desde aquí por seguridad</li>
      </ul>
    </div>
  </div>

  <ng-template #loadingTemplate>
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando tu perfil...</p>
    </div>
  </ng-template>
</div>
