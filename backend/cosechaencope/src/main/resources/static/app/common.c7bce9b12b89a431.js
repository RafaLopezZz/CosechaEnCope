"use strict";(self.webpackChunkcosecha_en_cope=self.webpackChunkcosecha_en_cope||[]).push([[76],{583:(C,P,t)=>{t.d(P,{k:()=>p});var n=t(2615),i=t(9330),E=t(4412),r=t(8810),l=t(9437),D=t(6354),S=t(8141),h=t(5479);let p=(()=>{class u{http=(0,n.WQX)(i.Qq);initialState={ordenes:[],loading:!1,error:null,filtrosActivos:{}};ovpStateSubject=new E.t(this.initialState);state$=this.ovpStateSubject.asObservable();ordenes$=this.state$.pipe((0,D.T)(a=>a.ordenes));loading$=this.state$.pipe((0,D.T)(a=>a.loading));cargarOrdenes(a){this.updateState({loading:!0,error:null}),this.http.get(h.Sn.ORDENES_VENTA_PRODUCTOR.GET_BY_PRODUCTOR(a)).pipe((0,D.T)(s=>this.mapearOrdenes(s)),(0,S.M)(s=>{const d=s.sort((A,e)=>new Date(e.fechaCreacion).getTime()-new Date(A.fechaCreacion).getTime());this.updateState({loading:!1,ordenes:d})}),(0,l.W)(s=>(this.handleError(s),(0,r.$)(()=>s)))).subscribe()}getOrdenPorId(a){return this.ordenes$.pipe((0,D.T)(s=>s.find(d=>d.idOvp===a)))}actualizarEstado(a,s,d,A=""){const e=this.ovpStateSubject.getValue();if(!e.ordenes.find(o=>o.idOvp===s))return(0,r.$)(()=>new Error("Orden no encontrada en memoria"));const _=e.ordenes.map(o=>o.idOvp===s?{...o,estado:d,observaciones:A||o.observaciones,isUpdating:!0}:o);this.updateState({ordenes:_});const O={estado:d,observaciones:A};return this.http.patch(`${h.Sn.ORDENES_VENTA_PRODUCTOR.GET_BY_PRODUCTOR(a)}/ordenes/${s}/estado`,O).pipe((0,S.M)(o=>{const T=this.ovpStateSubject.getValue().ordenes.map(g=>g.idOvp===s?{...o,isUpdating:!1}:g);this.updateState({ordenes:T}),console.log(`[OVP] Estado actualizado a ${d}`)}),(0,l.W)(o=>(console.error("[OVP] Fallo al actualizar, revirtiendo...",o),this.updateState({ordenes:e.ordenes,error:"No se pudo actualizar el estado. Intente nuevamente."}),(0,r.$)(()=>o))))}mapearOrdenes(a){return a.map(s=>this.mapearOrden(s))}mapearOrden(a){return{...a,detalles:a.detalles||a.lineas||[]}}updateState(a){this.ovpStateSubject.next({...this.ovpStateSubject.getValue(),...a})}handleError(a){this.updateState({loading:!1,error:a.error?.message||"Error de conexi\xf3n"})}static \u0275fac=function(s){return new(s||u)};static \u0275prov=n.jDH({token:u,factory:u.\u0275fac,providedIn:"root"})}return u})()},4730:(C,P,t)=>{t.d(P,{M:()=>r});var n=t(2615),i=t(9330),E=t(5479);let r=(()=>{class l{http=(0,n.WQX)(i.Qq);getClientes(){return this.http.get(E.Sn.CLIENTES.GET_ALL)}getClientePorUsuario(S){return this.http.get(E.Sn.CLIENTES.GET_BY_USER_ID(S))}updateCliente(S,h){return console.log("[ClienteService] \u{1f4dd} Actualizando datos del cliente:",{idUsuario:S,cliente:h}),this.http.put(E.Sn.CLIENTES.UPDATE_BY_USER_ID(S),h)}static \u0275fac=function(h){return new(h||l)};static \u0275prov=n.jDH({token:l,factory:l.\u0275fac,providedIn:"root"})}return l})()},5884:(C,P,t)=>{t.d(P,{b:()=>n});var n=function(i){return i.PENDIENTE="PENDIENTE",i.EN_PROCESO="EN_PROCESO",i.ENVIADA="ENVIADA",i.ENTREGADA="ENTREGADA",i.CANCELADA="CANCELADA",i}(n||{})},8234:(C,P,t)=>{t.d(P,{W1:()=>i,b8:()=>E,u3:()=>n});var n=function(r){return r.PENDIENTE="PENDIENTE",r.CONFIRMADO="CONFIRMADO",r.EN_PREPARACION="EN_PREPARACION",r.ENVIADO="ENVIADO",r.ENTREGADO="ENTREGADO",r.CANCELADO="CANCELADO",r}(n||{}),i=function(r){return r.TARJETA="TARJETA",r.TRANSFERENCIA="TRANSFERENCIA",r.EFECTIVO="EFECTIVO",r.PAYPAL="PAYPAL",r}(i||{}),E=function(r){return r.RESUMEN="RESUMEN",r.DATOS="DATOS",r.PAGO="PAGO",r.CONFIRMACION="CONFIRMACION",r}(E||{})},8685:(C,P,t)=>{t.d(P,{H:()=>s});var n=t(2615),i=t(9330),E=t(4412),r=t(8810),l=t(9437),D=t(6354),S=t(5558),h=t(8141),p=t(5479),u=t(8234),v=t(4730),a=t(9675);let s=(()=>{class d{http=(0,n.WQX)(i.Qq);clienteService=(0,n.WQX)(v.M);userStore=(0,n.WQX)(a.w);checkoutStateSubject=new E.t({step:u.b8.RESUMEN,clienteData:null,metodoPago:null,isProcessing:!1,error:null});checkoutState$=this.checkoutStateSubject.asObservable();ultimoPedidoSubject=new E.t(null);ultimoPedido$=this.ultimoPedidoSubject.asObservable();crearPedido(e=p.uq.TARJETA){console.log("[PedidoService] \u{1f6d2} Iniciando creaci\xf3n de pedido con m\xe9todo de pago:",e),this.updateCheckoutState({isProcessing:!0,error:null});const _=this.getCheckoutState().clienteData,O=this.userStore.snapshot();return _&&O?.idUsuario?(console.log("[PedidoService] \u{1f4dd} Actualizando perfil del cliente antes de crear pedido"),this.clienteService.updateCliente(O.idUsuario,{nombre:_.nombre,direccion:_.direccion,telefono:_.telefono}).pipe((0,h.M)(()=>console.log("[PedidoService] \u2705 Perfil actualizado, procediendo a crear pedido")),(0,S.n)(()=>this.http.post(`${p.Sn.PEDIDOS.CREATE}?metodoPago=${e}`,{})),(0,h.M)(o=>{this.ultimoPedidoSubject.next(o),this.updateCheckoutState({step:u.b8.CONFIRMACION,isProcessing:!1}),console.log("[PedidoService] \u2705 Pedido creado exitosamente:",o.idTransaccion)}),(0,l.W)(o=>(this.updateCheckoutState({isProcessing:!1,error:this.extractErrorMessage(o)}),console.error("[PedidoService] \u274c Error al crear pedido:",o),(0,r.$)(()=>o))))):(console.warn("[PedidoService] \u26a0\ufe0f No hay datos del cliente en checkout, creando pedido sin actualizar perfil"),this.http.post(`${p.Sn.PEDIDOS.CREATE}?metodoPago=${e}`,{}).pipe((0,h.M)(o=>{this.ultimoPedidoSubject.next(o),this.updateCheckoutState({step:u.b8.CONFIRMACION,isProcessing:!1}),console.log("[PedidoService] \u2705 Pedido creado:",o.idTransaccion)}),(0,l.W)(o=>(this.updateCheckoutState({isProcessing:!1,error:this.extractErrorMessage(o)}),console.error("[PedidoService] \u274c Error al crear pedido:",o),(0,r.$)(()=>o)))))}getPedidosUsuario(){return this.http.get(p.Sn.PEDIDOS.GET_BY_USER).pipe((0,D.T)(e=>e.sort((c,_)=>new Date(_.fechaPedido).getTime()-new Date(c.fechaPedido).getTime())),(0,l.W)(e=>(console.error("[PedidoService] Error al obtener pedidos:",e),(0,r.$)(()=>e))))}getPedidoPorId(e){return this.http.get(`${p.Sn.PEDIDOS.BASE}/pedidos/${e}`).pipe((0,l.W)(c=>(console.error(`[PedidoService] Error al obtener pedido ${e}:`,c),(0,r.$)(()=>c))))}iniciarCheckout(){this.checkoutStateSubject.next({step:u.b8.RESUMEN,clienteData:null,metodoPago:null,isProcessing:!1,error:null}),console.log("[PedidoService] \u{1f6d2} Checkout iniciado")}avanzarPaso(e){this.updateCheckoutState({step:e,error:null}),console.log("[PedidoService] \u27a1\ufe0f Avanzando a paso:",e)}retrocederPaso(){const e=this.checkoutStateSubject.getValue(),c=Object.values(u.b8),_=c.indexOf(e.step);if(_>0){const O=c[_-1];this.updateCheckoutState({step:O,error:null}),console.log("[PedidoService] \u2b05\ufe0f Retrocediendo a paso:",O)}}guardarDatosCliente(e){this.updateCheckoutState({clienteData:e}),console.log("[PedidoService] \u{1f4be} Datos del cliente guardados")}guardarMetodoPago(e){this.updateCheckoutState({metodoPago:e}),console.log("[PedidoService] \u{1f4b3} M\xe9todo de pago guardado:",e)}validarDatosCliente(e){return!e.nombre||e.nombre.trim().length<3?(this.updateCheckoutState({error:"El nombre debe tener al menos 3 caracteres"}),!1):e.email&&this.validarEmail(e.email)?!e.telefono||e.telefono.trim().length<9?(this.updateCheckoutState({error:"Tel\xe9fono inv\xe1lido"}),!1):!(!e.direccion||e.direccion.trim().length<10)||(this.updateCheckoutState({error:"La direcci\xf3n debe ser m\xe1s completa"}),!1):(this.updateCheckoutState({error:"Email inv\xe1lido"}),!1)}cancelarCheckout(){this.checkoutStateSubject.next({step:u.b8.RESUMEN,clienteData:null,metodoPago:null,isProcessing:!1,error:null}),this.ultimoPedidoSubject.next(null),console.log("[PedidoService] \u274c Checkout cancelado")}getCheckoutState(){return this.checkoutStateSubject.getValue()}updateCheckoutState(e){const c=this.checkoutStateSubject.getValue();this.checkoutStateSubject.next({...c,...e})}extractErrorMessage(e){return e.error?.message?e.error.message:e.message?e.message:"Error desconocido al procesar el pedido"}validarEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}static \u0275fac=function(c){return new(c||d)};static \u0275prov=n.jDH({token:d,factory:d.\u0275fac,providedIn:"root"})}return d})()}}]);