"use strict";(self.webpackChunkcosecha_en_cope=self.webpackChunkcosecha_en_cope||[]).push([[76],{4730:(C,h,o)=>{o.d(h,{M:()=>t});var i=o(2615),d=o(9330),s=o(5479);let t=(()=>{class c{http=(0,i.WQX)(d.Qq);getClientes(){return this.http.get(s.Sn.CLIENTES.GET_ALL)}getClientePorUsuario(u){return this.http.get(s.Sn.CLIENTES.GET_BY_USER_ID(u))}updateCliente(u,l){return console.log("[ClienteService] \u{1f4dd} Actualizando datos del cliente:",{idUsuario:u,cliente:l}),this.http.put(s.Sn.CLIENTES.UPDATE_BY_USER_ID(u),l)}static \u0275fac=function(l){return new(l||c)};static \u0275prov=i.jDH({token:c,factory:c.\u0275fac,providedIn:"root"})}return c})()},8234:(C,h,o)=>{o.d(h,{W1:()=>d,b8:()=>s,u3:()=>i});var i=function(t){return t.PENDIENTE="PENDIENTE",t.CONFIRMADO="CONFIRMADO",t.EN_PREPARACION="EN_PREPARACION",t.ENVIADO="ENVIADO",t.ENTREGADO="ENTREGADO",t.CANCELADO="CANCELADO",t}(i||{}),d=function(t){return t.TARJETA="TARJETA",t.TRANSFERENCIA="TRANSFERENCIA",t.EFECTIVO="EFECTIVO",t.PAYPAL="PAYPAL",t}(d||{}),s=function(t){return t.RESUMEN="RESUMEN",t.DATOS="DATOS",t.PAGO="PAGO",t.CONFIRMACION="CONFIRMACION",t}(s||{})},8685:(C,h,o)=>{o.d(h,{H:()=>g});var i=o(2615),d=o(9330),s=o(4412),t=o(8810),c=o(9437),D=o(6354),u=o(5558),l=o(8141),S=o(5479),E=o(8234),p=o(4730),O=o(9675);let g=(()=>{class P{http=(0,i.WQX)(d.Qq);clienteService=(0,i.WQX)(p.M);userStore=(0,i.WQX)(O.w);checkoutStateSubject=new s.t({step:E.b8.RESUMEN,clienteData:null,metodoPago:null,isProcessing:!1,error:null});checkoutState$=this.checkoutStateSubject.asObservable();ultimoPedidoSubject=new s.t(null);ultimoPedido$=this.ultimoPedidoSubject.asObservable();crearPedido(e=S.uq.TARJETA){console.log("[PedidoService] \u{1f6d2} Iniciando creaci\xf3n de pedido con m\xe9todo de pago:",e),this.updateCheckoutState({isProcessing:!0,error:null});const a=this.getCheckoutState().clienteData,_=this.userStore.snapshot();return a&&_?.idUsuario?(console.log("[PedidoService] \u{1f4dd} Actualizando perfil del cliente antes de crear pedido"),this.clienteService.updateCliente(_.idUsuario,{nombre:a.nombre,direccion:a.direccion,telefono:a.telefono}).pipe((0,l.M)(()=>console.log("[PedidoService] \u2705 Perfil actualizado, procediendo a crear pedido")),(0,u.n)(()=>this.http.post(`${S.Sn.PEDIDOS.CREATE}?metodoPago=${e}`,{})),(0,l.M)(n=>{this.ultimoPedidoSubject.next(n),this.updateCheckoutState({step:E.b8.CONFIRMACION,isProcessing:!1}),console.log("[PedidoService] \u2705 Pedido creado exitosamente:",n.idTransaccion)}),(0,c.W)(n=>(this.updateCheckoutState({isProcessing:!1,error:this.extractErrorMessage(n)}),console.error("[PedidoService] \u274c Error al crear pedido:",n),(0,t.$)(()=>n))))):(console.warn("[PedidoService] \u26a0\ufe0f No hay datos del cliente en checkout, creando pedido sin actualizar perfil"),this.http.post(`${S.Sn.PEDIDOS.CREATE}?metodoPago=${e}`,{}).pipe((0,l.M)(n=>{this.ultimoPedidoSubject.next(n),this.updateCheckoutState({step:E.b8.CONFIRMACION,isProcessing:!1}),console.log("[PedidoService] \u2705 Pedido creado:",n.idTransaccion)}),(0,c.W)(n=>(this.updateCheckoutState({isProcessing:!1,error:this.extractErrorMessage(n)}),console.error("[PedidoService] \u274c Error al crear pedido:",n),(0,t.$)(()=>n)))))}getPedidosUsuario(){return this.http.get(S.Sn.PEDIDOS.GET_BY_USER).pipe((0,D.T)(e=>e.sort((r,a)=>new Date(a.fechaPedido).getTime()-new Date(r.fechaPedido).getTime())),(0,c.W)(e=>(console.error("[PedidoService] Error al obtener pedidos:",e),(0,t.$)(()=>e))))}getPedidoPorId(e){return this.http.get(`${S.Sn.PEDIDOS.BASE}/pedidos/${e}`).pipe((0,c.W)(r=>(console.error(`[PedidoService] Error al obtener pedido ${e}:`,r),(0,t.$)(()=>r))))}iniciarCheckout(){this.checkoutStateSubject.next({step:E.b8.RESUMEN,clienteData:null,metodoPago:null,isProcessing:!1,error:null}),console.log("[PedidoService] \u{1f6d2} Checkout iniciado")}avanzarPaso(e){this.updateCheckoutState({step:e,error:null}),console.log("[PedidoService] \u27a1\ufe0f Avanzando a paso:",e)}retrocederPaso(){const e=this.checkoutStateSubject.getValue(),r=Object.values(E.b8),a=r.indexOf(e.step);if(a>0){const _=r[a-1];this.updateCheckoutState({step:_,error:null}),console.log("[PedidoService] \u2b05\ufe0f Retrocediendo a paso:",_)}}guardarDatosCliente(e){this.updateCheckoutState({clienteData:e}),console.log("[PedidoService] \u{1f4be} Datos del cliente guardados")}guardarMetodoPago(e){this.updateCheckoutState({metodoPago:e}),console.log("[PedidoService] \u{1f4b3} M\xe9todo de pago guardado:",e)}validarDatosCliente(e){return!e.nombre||e.nombre.trim().length<3?(this.updateCheckoutState({error:"El nombre debe tener al menos 3 caracteres"}),!1):e.email&&this.validarEmail(e.email)?!e.telefono||e.telefono.trim().length<9?(this.updateCheckoutState({error:"Tel\xe9fono inv\xe1lido"}),!1):!(!e.direccion||e.direccion.trim().length<10)||(this.updateCheckoutState({error:"La direcci\xf3n debe ser m\xe1s completa"}),!1):(this.updateCheckoutState({error:"Email inv\xe1lido"}),!1)}cancelarCheckout(){this.checkoutStateSubject.next({step:E.b8.RESUMEN,clienteData:null,metodoPago:null,isProcessing:!1,error:null}),this.ultimoPedidoSubject.next(null),console.log("[PedidoService] \u274c Checkout cancelado")}getCheckoutState(){return this.checkoutStateSubject.getValue()}updateCheckoutState(e){const r=this.checkoutStateSubject.getValue();this.checkoutStateSubject.next({...r,...e})}extractErrorMessage(e){return e.error?.message?e.error.message:e.message?e.message:"Error desconocido al procesar el pedido"}validarEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}static \u0275fac=function(r){return new(r||P)};static \u0275prov=i.jDH({token:P,factory:P.\u0275fac,providedIn:"root"})}return P})()}}]);