<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<body>

<!-- Header Fragment -->
<header th:fragment="header" class="navbar navbar-expand-lg navbar-light bg-white sticky-top shadow-sm">
  <div class="container">
    
    <!-- Logo -->
    <a class="navbar-brand d-flex align-items-center" href="/" aria-label="Ir a inicio" onclick="window.location.href='/'; return false;">
      <img
        src="/images/logo_test.svg"
        width="160"
        height="60"
        alt="Cosecha en Cope"
        class="navbar-logo"
      />
    </a>

    <!-- Mobile Menu Toggle -->
    <button 
      class="navbar-toggler" 
      type="button" 
      data-bs-toggle="collapse" 
      data-bs-target="#navbarNav"
      aria-controls="navbarNav" 
      aria-expanded="false" 
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Navigation Links -->
    <div class="collapse navbar-collapse" id="navbarNav">
      <nav class="navbar-nav me-auto" aria-label="Navegación principal">
        <a 
          class="nav-link px-3 py-2 rounded-2" 
          href="/"
          th:classappend="${currentPath == '/'} ? ' active'"
          onclick="window.location.href='/'; return false;"
        >
          <span>Inicio</span>
        </a>
        
        <a 
          class="nav-link px-3 py-2 rounded-2" 
          href="/app/articulos"
          th:classappend="${currentPath == '/app/articulos'} ? ' active'"
        >
          <span>Productos</span>
        </a>
        
        <a 
          class="nav-link px-3 py-2 rounded-2" 
          href="/app/categorias"
          th:classappend="${currentPath == '/app/categorias'} ? ' active'"
        >
          <span>Categorías</span>
        </a>
        
        <a 
          class="nav-link px-3 py-2 rounded-2" 
          href="/nosotros"
          th:classappend="${currentPath == '/nosotros'} ? ' active'"
          onclick="window.location.href='/nosotros'; return false;"
        >
          <span>¿Quiénes somos?</span>
        </a>
        
        <a 
          class="nav-link px-3 py-2 rounded-2" 
          href="/contacto"
          th:classappend="${currentPath == '/contacto'} ? ' active'"
          onclick="window.location.href='/contacto'; return false;"
        >
          <span>Contacto</span>
        </a>
        
        <a 
          class="nav-link px-3 py-2 rounded-2 position-relative" 
          href="/app/carrito"
          th:classappend="${currentPath == '/app/carrito'} ? ' active'"
        >
          <i class="fas fa-shopping-cart me-2"></i>
          <span>Carrito</span>
          <!-- Badge contador dinámico (se actualiza con JavaScript) -->
          <span id="carritoCounter" class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle" style="display: none;">
            0
          </span>
        </a>
      </nav>

      <!-- CTA Actions -->
      <div class="navbar-nav">
        <a 
          id="authButton"
          class="btn btn-primary btn-sm px-4 py-2 rounded-pill fw-semibold d-flex align-items-center" 
          href="/app/auth"
        >
          <i id="authIcon" class="fas fa-user-plus me-2"></i>
          <span id="authText">Acceder</span>
        </a>
      </div>
    </div>
  </div>
  
  <!-- Script para gestión dinámica del botón de autenticación -->
  <script>
    (function() {
      /**
       * Actualiza el botón de autenticación según el estado del usuario
       * Lee desde sessionStorage para detectar si hay un usuario autenticado
       */
      function actualizarBotonAuth() {
        const authButton = document.getElementById('authButton');
        const authIcon = document.getElementById('authIcon');
        const authText = document.getElementById('authText');
        
        if (!authButton || !authIcon || !authText) return;
        
        // Verificar si el usuario está autenticado
        const token = sessionStorage.getItem('authToken');
        const currentUser = sessionStorage.getItem('currentUser');
        
        if (token && currentUser) {
          try {
            const user = JSON.parse(currentUser);
            
            // Determinar la ruta del dashboard según el tipo de usuario
            let dashboardRoute = '/app/auth';
            let buttonText = 'Acceder';
            let iconClass = 'fas fa-user-plus me-2';
            
            if (user.tipoUsuario === 'CLIENTE') {
              dashboardRoute = '/app/cliente/dashboard';
              buttonText = 'Mi Panel';
              iconClass = 'fas fa-user-circle me-2';
            } else if (user.tipoUsuario === 'PRODUCTOR') {
              dashboardRoute = '/app/productor/dashboard';
              buttonText = 'Panel Productor';
              iconClass = 'fas fa-tachometer-alt me-2';
            }
            
            // Actualizar el botón
            authButton.href = dashboardRoute;
            authIcon.className = iconClass;
            authText.textContent = buttonText;
          } catch (e) {
            console.error('Error al parsear usuario autenticado:', e);
          }
        } else {
          // Usuario no autenticado: resetear a valores por defecto
          authButton.href = '/app/auth';
          authIcon.className = 'fas fa-user-plus me-2';
          authText.textContent = 'Acceder';
        }
      }
      
      // Actualizar al cargar la página
      actualizarBotonAuth();
      
      // Escuchar cambios en sessionStorage (para sincronización entre tabs)
      window.addEventListener('storage', function(e) {
        if (e.key === 'authToken' || e.key === 'currentUser') {
          actualizarBotonAuth();
        }
      });
      
      // Actualizar periódicamente (cada 2 segundos) para detectar cambios de sesión
      setInterval(actualizarBotonAuth, 2000);
    })();
  </script>
  
  <!-- Script para actualizar el contador del carrito desde localStorage -->
  <script>
    (function() {
      /**
       * Actualiza el badge del contador de carrito en tiempo real
       * Lee desde localStorage para usuarios invitados o desde sessionStorage para autenticados
       */
      function actualizarContadorCarrito() {
        const badge = document.getElementById('carritoCounter');
        if (!badge) return;
        
        let totalItems = 0;
        
        // Verificar si el usuario está autenticado
        const token = sessionStorage.getItem('authToken');
        
        if (!token) {
          // Usuario invitado: leer desde localStorage
          const carritoInvitado = localStorage.getItem('carritoInvitado');
          if (carritoInvitado) {
            try {
              const items = JSON.parse(carritoInvitado);
              totalItems = items.reduce((sum, item) => sum + item.cantidad, 0);
            } catch (e) {
              console.error('Error al parsear carrito invitado:', e);
            }
          }
        } else {
          // Usuario autenticado: podrías hacer un fetch al backend aquí
          // Por ahora, confiaremos en que Angular actualice esto
          // cuando el usuario esté en la SPA
          totalItems = 0; // Se actualizará en Angular
        }
        
        // Mostrar/ocultar badge
        if (totalItems > 0) {
          badge.textContent = totalItems;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }
      
      // Actualizar al cargar la página
      actualizarContadorCarrito();
      
      // Escuchar cambios en localStorage (para sincronización entre tabs)
      window.addEventListener('storage', function(e) {
        if (e.key === 'carritoInvitado') {
          actualizarContadorCarrito();
        }
      });
      
      // Actualizar periódicamente (cada 2 segundos)
      setInterval(actualizarContadorCarrito, 2000);
    })();
  </script>
</header>

</body>
</html>