<!-- Gallery Carousel (Productos Destacados) Fragment -->
<section class="gallery py-5" th:fragment="gallery">
  <div class="container">
    <!-- Header -->
    <div class="gallery__header text-center mb-5">
      <h2 class="display-5 fw-bold mb-3">Productos Destacados</h2>
      <p class="lead text-muted">
        Conoce lo mejor de nuestros productores locales
      </p>
    </div>

    <!-- Carousel -->
    <div
      class="gallery__carousel position-relative"
      th:if="${articulos != null && !articulos.isEmpty()}"
    >
      <!-- Previous Arrow -->
      <button
        class="gallery__arrow gallery__arrow--prev"
        onclick="scrollGallery(-1)"
        aria-label="Producto anterior"
      >
        <i class="fas fa-chevron-left"></i>
      </button>

      <!-- Viewport -->
      <div class="gallery__viewport">
        <div class="gallery__track" id="galleryTrack">
          <!-- Gallery Items -->
          <div
            class="gallery__item"
            th:each="articulo, iterStat : ${articulos}"
            th:classappend="${iterStat.index == 0} ? 'active'"
          >
            <div class="item__image-wrapper">
              <!-- Product Image -->
              <img
                th:src="${articulo.imagenUrl}"
                th:alt="${articulo.nombre}"
                class="item__image"
                loading="lazy"
                onerror="this.onerror=null; this.src='/images/placeholder-product.svg';"
              />

              <!-- Overlay with product info -->
              <div class="item__overlay">
                <div class="item__content">
                  <h3 class="item__name" th:text="${articulo.nombre}">
                    Nombre del producto
                  </h3>
                  <p
                    class="item__producer"
                    th:text="${articulo.nombreProductor}"
                  >
                    Productor
                  </p>
                  <span
                    class="item__category"
                    th:text="${articulo.nombreCategoria}"
                    >Categoría</span
                  >
                  <span
                    class="item__price"
                    th:if="${articulo.precio != null && articulo.precio > 0}"
                    th:text="${#numbers.formatDecimal(articulo.precio, 1, 2)} + ' €'"
                  >
                    0.00 €
                  </span>
                </div>
                <div class="item__actions">
                  <a
                    href="/app/articulos"
                    class="btn-view"
                    aria-label="Ver productos"
                  >
                    <i class="fas fa-eye"></i>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Next Arrow -->
      <button
        class="gallery__arrow gallery__arrow--next"
        onclick="scrollGallery(1)"
        aria-label="Siguiente producto"
      >
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>

    <!-- Indicators -->
    <div
      class="gallery__indicators text-center mt-4"
      th:if="${articulos != null && !articulos.isEmpty()}"
    >
      <button
        class="indicator"
        th:each="articulo, iterStat : ${articulos}"
        th:classappend="${iterStat.index == 0} ? 'active'"
        th:onclick="'goToGallerySlide(' + ${iterStat.index} + ')'"
        th:attr="aria-label='Ir al producto ' + ${iterStat.index + 1}"
      ></button>
    </div>

    <!-- CTA Button -->
    <div
      class="gallery__cta text-center mt-5"
      th:if="${articulos != null && !articulos.isEmpty()}"
    >
      <a
        href="/app/articulos"
        class="btn btn-primary btn-lg rounded-pill px-5 py-3"
      >
        <span>Ver Todos los Productos</span>
        <i class="fas fa-arrow-right ms-2"></i>
      </a>
    </div>

    <!-- Empty State -->
    <div
      class="text-center py-5"
      th:if="${articulos == null || articulos.isEmpty()}"
    >
      <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
      <h3 class="h4 text-muted">No hay productos disponibles</h3>
      <p class="text-muted">Pronto añadiremos nuevos productos frescos.</p>
      <a href="/app/articulos" class="btn btn-primary mt-3">
        <i class="fas fa-search me-2"></i> Explorar catálogo
      </a>
    </div>
  </div>

  <!-- Carousel JavaScript -->
  <script th:inline="none">
    // Variables globales para el carousel
    let galleryCurrentIndex = 0;
    let galleryTotalSlides = 0;
    let galleryAutoPlayInterval = null;
    let galleryCardWidth = 328; // Valor por defecto (296px card + 32px gap)
    let galleryIsNativeScroll = false; // Detectar si usa scroll nativo (móvil)

  // Detectar si el carrusel usa scroll nativo (pantallas <= 480px)
  function isNativeScrollMode() {
    const track = document.getElementById("galleryTrack");
    if (!track) return false;
    
    const style = getComputedStyle(track);
    // Si overflow-x es auto o scroll, usa scroll nativo
    return style.overflowX === 'auto' || style.overflowX === 'scroll';
  }

  // Función para calcular el ancho de una tarjeta + gap
  function calculateGalleryCardWidth() {
    const track = document.getElementById("galleryTrack");
    if (!track) return 328;
    
    const items = track.querySelectorAll(".gallery__item");
    if (items.length === 0) return 328;
    
    const firstItem = items[0];
    const secondItem = items[1];
    
    // Si hay al menos 2 items, calculamos el gap real midiendo la diferencia
    if (secondItem) {
      const firstRect = firstItem.getBoundingClientRect();
      const secondRect = secondItem.getBoundingClientRect();
      // La diferencia entre el inicio del segundo y el inicio del primero = ancho + gap
      galleryCardWidth = secondRect.left - firstRect.left;
    } else {
      // Solo hay un item, usamos su ancho + gap estimado
      const itemRect = firstItem.getBoundingClientRect();
      const style = getComputedStyle(track);
      const gap = parseFloat(style.columnGap) || parseFloat(style.gap) || 32;
      galleryCardWidth = itemRect.width + gap;
    }
    
    return galleryCardWidth;
  }

  // Actualizar la posición del carousel
  function updateGallery() {
    const track = document.getElementById("galleryTrack");
    if (!track || galleryTotalSlides === 0) return;

    // Actualizar modo de scroll
    galleryIsNativeScroll = isNativeScrollMode();
    
    // Recalcular el ancho de la tarjeta
    calculateGalleryCardWidth();
    
    if (galleryIsNativeScroll) {
      // Modo scroll nativo: limpiar transform y usar scrollLeft
      track.style.transform = '';
      const scrollPosition = galleryCurrentIndex * galleryCardWidth;
      track.scrollTo({ left: scrollPosition, behavior: 'smooth' });
    } else {
      // Modo transform: usar translateX
      const offset = -(galleryCurrentIndex * galleryCardWidth);
      track.style.transform = `translateX(${offset}px)`;
    }

    // Actualizar clases active en items
    const items = track.querySelectorAll(".gallery__item");
    items.forEach((item, index) => {
      item.classList.toggle("active", index === galleryCurrentIndex);
    });

    // Actualizar indicadores
    const indicators = document.querySelectorAll(".gallery__indicators .indicator");
    indicators.forEach((indicator, index) => {
      indicator.classList.toggle("active", index === galleryCurrentIndex);
    });
  }

  // Navegar en el carousel (función global para onclick)
  function scrollGallery(direction) {
    if (galleryTotalSlides === 0) return;

    galleryCurrentIndex += direction;

    // Loop infinito
    if (galleryCurrentIndex < 0) {
      galleryCurrentIndex = galleryTotalSlides - 1;
    } else if (galleryCurrentIndex >= galleryTotalSlides) {
      galleryCurrentIndex = 0;
    }

    updateGallery();
  }

  // Ir a un slide específico (función global para onclick)
  function goToGallerySlide(index) {
    if (index >= 0 && index < galleryTotalSlides) {
      galleryCurrentIndex = index;
      updateGallery();
    }
  }

  // Función para iniciar autoplay
  function startGalleryAutoPlay() {
    if (galleryAutoPlayInterval) return; // Ya está corriendo
    
    galleryAutoPlayInterval = setInterval(() => {
      scrollGallery(1);
    }, 5000);
  }

  // Función para detener autoplay
  function stopGalleryAutoPlay() {
    if (galleryAutoPlayInterval) {
      clearInterval(galleryAutoPlayInterval);
      galleryAutoPlayInterval = null;
    }
  }

  // Sincronizar índice con scroll nativo en móvil
  function syncScrollPosition() {
    const track = document.getElementById("galleryTrack");
    if (!track || !galleryIsNativeScroll || galleryCardWidth === 0) return;
    
    const scrollLeft = track.scrollLeft;
    const newIndex = Math.round(scrollLeft / galleryCardWidth);
    
    if (newIndex !== galleryCurrentIndex && newIndex >= 0 && newIndex < galleryTotalSlides) {
      galleryCurrentIndex = newIndex;
      
      // Actualizar indicadores sin mover el scroll
      const indicators = document.querySelectorAll(".gallery__indicators .indicator");
      indicators.forEach((indicator, index) => {
        indicator.classList.toggle("active", index === galleryCurrentIndex);
      });
      
      // Actualizar clases active en items
      const items = track.querySelectorAll(".gallery__item");
      items.forEach((item, index) => {
        item.classList.toggle("active", index === galleryCurrentIndex);
      });
    }
  }

  // Inicializar cuando el DOM esté listo
  document.addEventListener("DOMContentLoaded", function () {
    const track = document.getElementById("galleryTrack");
    if (!track) return;

    const items = track.querySelectorAll(".gallery__item");
    galleryTotalSlides = items.length;
    
    if (galleryTotalSlides === 0) return;

    // Calcular ancho inicial después de que CSS esté aplicado
    // Usamos requestAnimationFrame para asegurar que el layout esté calculado
    requestAnimationFrame(() => {
      galleryIsNativeScroll = isNativeScrollMode();
      calculateGalleryCardWidth();
      updateGallery();
    });

    // Auto-play (cada 5 segundos)
    startGalleryAutoPlay();

    // Pausar auto-play al hacer hover o touch
    const carousel = document.querySelector(".gallery__carousel");
    if (carousel) {
      carousel.addEventListener("mouseenter", stopGalleryAutoPlay);
      carousel.addEventListener("mouseleave", startGalleryAutoPlay);
      carousel.addEventListener("touchstart", stopGalleryAutoPlay, { passive: true });
      carousel.addEventListener("touchend", function() {
        // Reiniciar autoplay después de 3 segundos de soltar
        setTimeout(startGalleryAutoPlay, 3000);
      }, { passive: true });
    }

    // Sincronizar scroll nativo con indicadores (para móvil)
    let scrollTimeout;
    track.addEventListener("scroll", function() {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(syncScrollPosition, 100);
    }, { passive: true });

    // Actualizar al cambiar tamaño de ventana (con debounce)
    let resizeTimeout;
    window.addEventListener("resize", function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        galleryIsNativeScroll = isNativeScrollMode();
        calculateGalleryCardWidth();
        updateGallery();
      }, 150);
    });
  });
  </script>
</section>
